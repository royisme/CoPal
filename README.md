# CoPal

**Agent Harness Configuration Tool**

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)

[简体中文](./README_CN.md) | English

## Overview

CoPal is an **Agent Harness Configuration Generator & Validator**. Its core purpose is to provide a standardized working environment (Harness) for AI programming assistants (such as **Anthropic Claude Code**, **OpenAI Codex CLI**, **Cursor**, etc.).

**CoPal is NOT an Agent, but a tool to prepare the environment for Agents.**

It generates static configuration files (`AGENTS.md`, Workflows, prompts) at **Init-time**, allowing generic AI Agents at **Run-time** to follow reusable, deterministic engineering processes.

## Core Features

- **Init-time Configuration**: Generates standardized `AGENTS.md` and workflow instructions once, avoiding repetitive prompting for every session.
- **Passive Orchestration**: Passes context and constraints to the Agent via the file system (`.copal/`) rather than actively hijacking the control flow.
- **Worktree Isolation**: Built-in Git Worktree management to create isolated development environments for each AI task, protecting the main branch.
- **Persistent Memory**: Manages project-specific knowledge and state (Memory) across sessions, preventing context loss.
- **Artifact Validation**: Provides the `copal validate` command to verify artifacts generated by the Agent (e.g., JSON Plans, Todo Lists) against schemas.
- **Universal Export**: The same configuration can be exported as Claude Code commands, Cursor Rules, or Codex Prompts.

## Quick Start

### 1. Installation

**Recommended: Use uv** (Fast, isolated installation)

```bash
# Install directly from PyPI (once published)
uv tool install copal-cli

# Or install from source
git clone https://github.com/royisme/CoPal.git
cd CoPal
uv tool install .
```

**Alternative: pip**

```bash
pip install -e .
```

### 2. Initialize Project (Init)

Run in any project root to generate the Harness configuration:

```bash
copal init
```

This will create:

- `AGENTS.md`: The entry point guide for AI Agents.
- `.copal/manifest.yaml`: The project configuration manifest.
- `.copal/packs/`: Installs default workflow packs (e.g., `engineering_loop`).

### 3. Create Isolated Worktree

Create an isolated Git Worktree for a new task to avoid polluting the current development environment:

```bash
# Create a new feature branch worktree named "feature-login"
copal worktree new feature-login
```

### 4. Export Instructions (Export)

Export the configuration to a format recognizable by your Agent tool:

```bash
# Export instructions for Claude Code
copal export claude
# Generated files are located in .claude/commands/copal/*.md
```

### 5. Run Agent

Start your AI Agent (e.g., Claude Code), and it will automatically read `AGENTS.md` and the exported instructions.

> **User**: "Claude, please start the task: Add generic export support to Copal CLI."

The Agent will follow the guide:

1. **Plan**: Generate a plan and write to `.copal/artifacts/plan.json`
2. **Research**: Call tools to research the codebase
3. **Work**: Implement code changes

### 6. Manage Memory

**Note: This feature is primarily designed for Agents to call via Tools at runtime, rather than for manual user operation.**
Agents can use the CoPal memory bank to store key decisions or context across sessions:

```bash
# Agent calls this command to add a new memory
copal memory add --type concept --content "The export module uses a plugin architecture."

# Agent calls this command to search memories
copal memory search --query "export module"
```

### 7. Validate Status (Validate)

Verify that artifacts meet specifications during or after the Agent's work:

```bash
# Validate configuration and correctness of artifacts generated by the Agent
copal validate --artifacts
```

## CLI Command Reference

| Command               | Purpose                                                                                      |
| --------------------- | -------------------------------------------------------------------------------------------- |
| `copal init`          | Initialize project, generate `AGENTS.md` and `.copal/` directory                             |
| `copal validate`      | Validate Manifest and Pack configurations. Use `--artifacts` to validate generated artifacts |
| `copal export <tool>` | Export instructions to specific tool format (supports `claude`, `codex`, `gemini`)           |
| `copal status`        | View current project Harness status and Artifacts summary                                    |
| `copal worktree`      | Manage Git Worktrees (`new`, `list`, `remove`) for task isolation                            |
| `copal memory`        | Manage project memory bank (`add`, `search`, `list`, `show`, `update`, `delete`)             |
| `copal mcp`           | View Model Context Protocol tool configuration status                                        |

## Directory Structure

Standard structure initialized by CoPal:

```
Project/
├── AGENTS.md                # Agent entry guide (contains only core principles and index)
├── .copal/
│   ├── manifest.yaml        # CoPal configuration
│   ├── artifacts/           # Runtime artifacts generated by Agent (plan.json, findings.json...)
│   ├── memory/              # SQL/JSON memory storage
│   ├── packs/               # Installed workflow packs
│   │   └── engineering_loop/
│   │       ├── workflows/   # Specific step instructions (md)
│   │       ├── prompts/     # Role Prompt templates
│   │       └── schemas/     # Artifact JSON Schemas
│   └── mcp-available.json   # MCP tool registry
```

## Contribution

Welcome contributions for new Workflow Packs or Tool Adapters!

1. Fork this repository
2. Create a feature branch
3. Submit changes
4. Open a Pull Request

## License

MIT License
