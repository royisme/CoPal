# CoPal 功能概览

CoPal 是一个全面的 AI 编程助手工作流管理工具。本文档详细介绍所有主要功能。

## 核心功能模块

### 1. 六阶段工作流编排 🔄

CoPal 提供结构化的软件开发工作流，确保从需求分析到代码提交的完整过程。

#### 阶段详解

**分析阶段（Analyze）**
- **目的：** 深入理解任务需求，收集相关上下文
- **输入：** 任务标题、目标、约束条件
- **输出：** 分析报告（`.copal/artifacts/analysis.md`）
- **角色：** 分析师
- **关键活动：**
  - 理解业务需求
  - 识别技术挑战
  - 收集相关背景知识
  - 评估可行性

**规范阶段（Spec）**
- **目的：** 编写正式的技术规范文档
- **输入：** 分析阶段的输出
- **输出：** 技术规范（`.copal/artifacts/spec.md`）
- **角色：** 规范员
- **关键活动：**
  - 定义功能需求
  - 明确技术约束
  - 设计接口规范
  - 制定验收标准

**计划阶段（Plan）**
- **目的：** 制定详细的实施计划
- **输入：** 规范和分析结果
- **输出：** 实施计划（`.copal/artifacts/plan.md`）
- **角色：** 计划员
- **关键活动：**
  - 分解任务
  - 确定实施顺序
  - 识别依赖关系
  - 估算工作量

**实现阶段（Implement）**
- **目的：** 按计划执行代码实现
- **输入：** 详细实施计划
- **输出：** 补丁说明（`.copal/artifacts/patch-notes.md`）
- **角色：** 实现者
- **关键活动：**
  - 编写代码
  - 添加测试
  - 更新文档
  - 记录变更

**审查阶段（Review）**
- **目的：** 评估代码质量，准备发布
- **输入：** 实现的代码和补丁说明
- **输出：** 审查报告（`.copal/artifacts/review.md`）
- **角色：** 审查者
- **关键活动：**
  - 代码质量检查
  - 测试覆盖验证
  - 安全审查
  - 准备 PR 描述

**提交阶段（Commit）**
- **目的：** 记录工作流元数据
- **输入：** 所有前序阶段的产物
- **输出：** 提交元数据（`.copal/artifacts/commit-metadata.json`）
- **角色：** 提交者
- **关键活动：**
  - 整理变更历史
  - 生成提交消息
  - 记录工作流指标
  - 归档产物

### 2. 知识库管理 📚

CoPal 提供完整的知识库系统，支持团队知识共享和最佳实践传播。

#### 知识库结构

**核心原则（Core）**
- 全局开发原则
- 环境防护规则
- 信息架构指南

**角色模板（Roles）**
- 分析师工作手册
- 规范员工作手册
- 计划员工作手册
- 实现者工作手册
- 审查者工作手册

**工作流指南（Workflows）**
- 规划到实现流程
- 实现循环模式
- 审查和发布流程
- 技能生命周期管理

**工具集（Toolsets）**
- 常用 CLI 工具参考
- 项目工具集成指南
- 安全防护脚本

#### 知识库特性

**YAML 前置元数据**
- 快速检索和过滤
- 版本控制
- 依赖关系管理

**模板覆盖机制**
- 保留共享模板
- 支持项目级覆盖
- 灵活的自定义能力

**验证工具**
- 自动验证元数据格式
- 确保知识库一致性
- 支持自定义验证规则

### 3. 技能系统 🛠️

技能系统允许团队创建、共享和重用自动化模块。

#### 技能组件

**技能元数据（skill.json）**
```json
{
  "id": "my-skill",
  "name": "My Automation Skill",
  "language": "python",
  "version": "1.0.0",
  "description": "自动化任务描述",
  "requires_sandbox": true,
  "tags": ["automation", "testing"]
}
```

**使用说明（prelude.md）**
- 运行时要求
- 配置说明
- 使用示例
- 注意事项

**脚本和测试**
- `scripts/` - 自动化脚本
- `tests/` - 测试用例
- `examples/` - 使用示例

**执行日志（entrypoint.log）**
- 记录执行过程
- 便于调试和审查

#### 技能功能

**脚手架生成**
- 快速创建技能结构
- 支持多种语言（Python、Bash、JavaScript 等）
- 自动生成模板文件

**注册表管理**
- 自动扫描和索引技能
- 生成 `registry.json`
- 支持版本管理

**搜索和发现**
- 模糊搜索技能
- 按语言过滤
- 标签分类

**沙箱执行**
- 安全的执行环境
- 资源限制
- 输出过滤
- 路径访问控制

### 4. 记忆层 🧠

记忆层在工作流运行之间持久化重要信息，形成团队知识图谱。

#### 记忆类型

**决策（Decision）**
- 技术选型决策
- 架构设计决策
- 工具和框架选择
- 示例：
  ```bash
  copal memory add --type decision \
    --content "使用 PostgreSQL 作为主数据库" \
    --metadata reason="高性能、ACID支持、丰富的生态"
  ```

**偏好（Preference）**
- 编码规范偏好
- 工具使用偏好
- 工作流程偏好
- 示例：
  ```bash
  copal memory add --type preference \
    --content "Python 代码使用 Black 格式化" \
    --metadata scope="project-wide"
  ```

**经验（Experience）**
- 问题解决经验
- 性能优化经验
- 错误处理经验
- 示例：
  ```bash
  copal memory add --type experience \
    --content "Redis 连接池大小应该与工作进程数匹配" \
    --metadata impact="performance"
  ```

**计划（Plan）**
- 功能开发计划
- 重构计划
- 迁移计划
- 示例：
  ```bash
  copal memory add --type plan \
    --content "Q1：完成微服务拆分" \
    --metadata priority="high"
  ```

**笔记（Note）**
- 技术笔记
- 会议记录
- 临时备注
- 示例：
  ```bash
  copal memory add --type note \
    --content "考虑使用 gRPC 替代 REST API" \
    --metadata context="architecture-discussion"
  ```

#### 记忆功能

**关系管理**
- `SUPERSEDES` - 取代关系
- `RELATES_TO` - 相关关系
- `DEPENDS_ON` - 依赖关系
- `REFERENCES` - 引用关系
- `TEMPORAL_SEQUENCE` - 时序关系
- `ASSOCIATED_WITH` - 关联关系

**查询能力**
- 关键词搜索
- 类型过滤
- 元数据查询
- 关系遍历

**作用域管理**
- `workflow_run` - 工作流运行作用域
- `global` - 全局作用域
- 自动范围隔离

**自动捕获**
- 可选的自动记忆捕获
- 每个阶段自动记录
- 可配置的捕获策略

### 5. MCP 集成 🔌

Model Context Protocol (MCP) 集成允许根据可用工具动态注入使用指导。

#### MCP 工具支持

**context7**
- 深度研究和知识获取
- 库和框架文档查询
- API 规范确认
- 阶段：分析、计划

**active-file**
- 文件定位和导航
- 代码编辑和修改
- 变更跟踪
- 阶段：实现

**file-tree**
- 目录结构探索
- 文件组织理解
- 路径导航
- 阶段：实现

#### 钩子机制

**条件触发**
```yaml
# 任一工具可用时触发
- id: context7-analysis
  stage: analysis
  any_mcp: ["context7"]
  inject:
    - mcp/context7/usage.analysis.md

# 所有工具都可用时触发
- id: active-file-implement
  stage: implement
  all_mcp: ["active-file", "file-tree"]
  inject:
    - mcp/active-file/usage.implement.md
```

**阶段特定指导**
- 每个工具可以有多个阶段的指导
- 指导内容针对阶段特点定制
- 自动注入到提示词中

**灵活配置**
- 易于添加新工具支持
- 支持自定义钩子块
- 可组合的规则系统

### 6. 提示词生成 📝

CoPal 自动生成结构化的提示词，确保 AI 助手获得完整上下文。

#### 提示词组成

**运行时头部**
- 当前阶段信息
- 任务元数据
- 可用工具列表
- 产物位置

**角色指导**
- 角色特定的职责
- 最佳实践指南
- 工作流程说明

**MCP 工具指导**
- 工具使用说明
- 示例和模板
- 注意事项

**上下文链接**
- 前序阶段产物
- 相关知识库文档
- 项目特定指导

#### 提示词特性

**自动组装**
- 根据配置自动组合
- 无需手动编辑
- 保证一致性

**版本控制**
- 提示词存储在 `.copal/runtime/`
- 可追踪历史版本
- 便于调试和优化

**可扩展性**
- 支持自定义模板
- 可注入项目特定内容
- 灵活的组合机制

## 实用工具

### 状态管理

**查看状态（status）**
- 显示所有阶段的提示词
- 列出现有产物
- 建议下一步操作
- 显示工作流进度

**恢复工作流（resume）**
- 显示最近的提示词
- 帮助中断后继续
- 提供上下文信息

### 验证工具

**知识库验证（validate）**
- 检查 YAML 前置元数据
- 验证文件格式
- 确保一致性
- 自定义验证规则

### 初始化工具

**项目初始化（init）**
- 复制模板文件
- 创建目录结构
- 可预览操作（dry-run）
- 支持强制覆盖

## 集成能力

### 版本控制集成
- `.copal/` 目录可提交到 Git
- 知识库文件版本控制
- 技能共享和协作
- 记忆持久化

### CI/CD 集成
- 可在 CI 流程中使用
- 自动化工作流验证
- 技能执行自动化
- 产物归档

### 团队协作
- 共享知识库和技能
- 统一工作流规范
- 记忆共享和继承
- 最佳实践传播

## 配置选项

### 全局配置

**知识库配置**
- 模板路径
- 覆盖策略
- 验证规则

**MCP 配置**
- 可用工具列表（`.copal/mcp-available.json`）
- 钩子规则（`.copal/hooks/hooks.yaml`）

**记忆配置**
- 后端选择（`.copal/memory-config.json`）
- 自动捕获策略
- 作用域管理

### 项目配置

**用户指导（UserAgents.md）**
- 项目结构说明
- 开发规范
- 工具链配置
- 自定义工作流

**自定义知识库**
- 角色覆盖
- 工作流扩展
- 工具集补充

## 扩展性

### 自定义角色
- 创建新的角色模板
- 扩展现有角色
- 项目特定角色

### 自定义工作流
- 添加新阶段
- 修改阶段顺序
- 定制工作流程

### 自定义技能
- 开发团队特定技能
- 封装常用操作
- 共享自动化模块

### 自定义钩子
- 添加新的 MCP 工具支持
- 创建自定义指导
- 扩展钩子系统

## 安全特性

### 沙箱执行
- 限制资源使用
- 控制文件访问
- 过滤敏感输出
- 隔离执行环境

### 验证机制
- 知识库格式验证
- 技能元数据验证
- 配置文件验证

### 权限控制
- 技能执行权限
- 文件访问权限
- 网络访问控制

## 性能优化

### 快速检索
- YAML 前置元数据索引
- 技能注册表缓存
- 记忆图索引

### 增量更新
- 仅同步变更的模板
- 增量构建注册表
- 智能缓存机制

## 总结

CoPal 提供了一个完整的 AI 编程助手工作流管理解决方案，包括：

✅ **结构化工作流** - 六个明确定义的阶段
✅ **知识管理** - 灵活的知识库系统
✅ **技能重用** - 自动化模块的创建和共享
✅ **记忆持久化** - 跨工作流的知识图谱
✅ **工具集成** - MCP 协议支持
✅ **团队协作** - 知识和经验共享
✅ **可扩展性** - 灵活的自定义能力
✅ **安全性** - 沙箱和验证机制

适用场景：
- 🎯 个人项目的结构化开发
- 👥 团队协作的知识共享
- 🤖 AI 助手的工作流编排
- 📚 最佳实践的积累和传播
- 🔧 自动化任务的封装和重用

更多详细信息，请参阅：
- [使用指南](./USAGE_CN.md)
- [快速开始](./QUICKSTART_CN.md)
- [开发指南](./DEVELOPMENT.md)
- [MCP 钩子](./HOOKS.md)
